--// Nervox Stand Bot
--// Made by KryvenDev

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer

local OwnerId = getgenv().OwnerId or 0
local BotSettings = getgenv().BotSettings or {}

-- ========= VARIABLES ========= --
local Whitelist = { [OwnerId] = true }
local AutoConnection, HideConnection, DropConnection
local ChatLogsVisible = false

-- ========= FPS LIMIT ========= --
local function applyFPSCap()
    local fps = BotSettings.MaxFps or 45
    if setfpscap then
        setfpscap(fps)
    end
end
applyFPSCap()

-- ========= UTILITIES ========= --
local function sendChat(msg)
    local ch = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
    if ch then ch:SendAsync(msg) end
end

local function getHumanoid()
    local char = LP.Character or LP.CharacterAdded:Wait()
    return char:FindFirstChildOfClass("Humanoid")
end

local function stopAll()
    if AutoConnection then AutoConnection:Disconnect() AutoConnection = nil end
    if HideConnection then HideConnection:Disconnect() HideConnection = nil end
    if DropConnection then DropConnection:Disconnect() DropConnection = nil end
end

local function findPlayerByName(query)
    query = query:lower()
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr.Name:lower():find(query, 1, true) or (plr.DisplayName and plr.DisplayName:lower():find(query, 1, true)) then
            return plr
        end
    end
end

-- ========= ANTI-FLING ========= --
local function applyAntiFling()
    RunService.Heartbeat:Connect(function()
        local char = LP.Character
        if not char then return end
        for _, part in ipairs(char:GetChildren()) do
            if part:IsA("BasePart") then
                part.Velocity = Vector3.new(0, part.Velocity.Y, 0)
                part.RotVelocity = Vector3.new(0, 0, 0)
            end
        end
    end)
end
applyAntiFling()

-- ========= CASH SYSTEM ========= --
local function dropCash(amount)
    amount = tonumber(amount)
    if not amount then return end
    if amount > 15000 then amount = 15000 end
    ReplicatedStorage:WaitForChild("MainEvent"):FireServer("DropMoney", tostring(amount))
end

local function autoDrop(amount)
    stopAll()
    amount = tonumber(amount)
    if not amount or amount <= 0 then amount = 15000 end
    if amount > 15000 then amount = 15000 end
    sendChat("Autodropping " .. tostring(amount) .. " | say stop! or s to stop!")
    DropConnection = RunService.Heartbeat:Connect(function()
        ReplicatedStorage:WaitForChild("MainEvent"):FireServer("DropMoney", tostring(amount))
        task.wait(0.5)
    end)
end

-- ========= CHAT LISTENER ========= --
TextChatService.OnIncomingMessage = function(message)
    local src = message.TextSource
    local sender = src and Players:GetPlayerByUserId(src.UserId)
    local msgText = message.Text or ""
    if not src then return end

    local isOwner = src.UserId == OwnerId
    local allowed = Whitelist[src.UserId]
    local txt = msgText:lower()

    -- Owner-only
    if isOwner and txt:sub(1,10) == "whitelist!" then
        local query = msgText:sub(11)
        local target = findPlayerByName(query)
        if target then
            Whitelist[target.UserId] = true
            sendChat("Whitelisted " .. target.Name)
        else
            sendChat("Invalid username")
        end
        return
    elseif isOwner and txt:sub(1,12) == "unwhitelist!" then
        local query = msgText:sub(13)
        local target = findPlayerByName(query)
        if target and target.UserId ~= OwnerId then
            Whitelist[target.UserId] = nil
            sendChat("Unwhitelisted " .. target.Name)
        else
            sendChat("Invalid username")
        end
        return
    end

    if not allowed then return end

    -- Normal commands
    if txt:sub(1,9) == "dropcash!" then
        local amount = msgText:sub(11)
        dropCash(amount)
    elseif txt:sub(1,9) == "autodrop!" then
        local amount = msgText:sub(11)
        autoDrop(amount)
    elseif txt == "stop!" or txt == "s" then
        stopAll()
        sendChat("Stopped all actions.")
    elseif txt == "cmds!" then
        sendChat("Commands (1/3): wallet!, unwallet!, summon!/s, auto! <user>, stop!/s")
        sendChat("Commands (2/3): chatlogs!, rj! (owner), whitelist!, unwhitelist!, checkwl!")
        sendChat("Commands (3/3): dropcash! <amount>, autodrop! <amount>, hide!, creds!")
    elseif txt == "creds!" then
        sendChat("Script made by KryvenDev")
    end
end
